on:
  push:
    branches: master

name: bookdown

jobs:
  build:
    runs-on: macOS-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Setup R
        uses: r-lib/actions/setup-r@master

      - name: Install pandoc and pandoc citeproc
        run: |
          brew install pandoc
          brew install pandoc-citeproc

        - name: Build site
        run: Rscript -e 'bookdown::render_book("index.Rmd", quiet = TRUE)'

      - name: Install npm
        uses: actions/setup-node@v1

      - name: Deploy to gh pages
        # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo's secrets
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          # configure your name and email if you have not done so
          git config --global user.email "l.wallrich@gold.ac.uk"
          git config --global user.name "Lukas Wallrich"

          # clone the repository to the book-output directory
          git clone -b gh-pages \
            https://${GITHUB_PAT}@github.com/${TRAVIS_REPO_SLUG}.git \
            book-output
          cd book-output
          git rm -rf *
          cp -r ../_book/* ./
          git add --all *
          git commit -m "Update the book"
          git push -q origin gh-pages
